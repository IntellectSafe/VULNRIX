{% extends "base.html" %}

{% block title %}Dashboard - VULNRIX{% endblock %}

{% block content %}
<div class="hacker-theme min-h-screen p-6 relative">
    <div class="scanline"></div>
    <div class="container mx-auto">
        <!-- Header -->
        <div class="flex justify-between items-end mb-8 border-b border-green-500/30 pb-4">
            <div>
                <h1 class="text-3xl font-bold tracking-tight mb-1 glitch" data-text="DIGITAL FOOTPRINT">
                    <i class="fas fa-user-secret mr-2"></i>DIGITAL_FOOTPRINT
                </h1>
                <p class="text-gray-400 font-mono text-xs">> MONITORING_TARGETS_ACTIVE</p>
            </div>
        <div class="flex gap-3">
            <button class="btn btn--outline" onclick="window.location.reload()">
                <i class="fas fa-sync-alt mr-2"></i> Refresh
            </button>
            <a href="{% url 'scanner:new_scan' %}" class="btn btn--primary shadow-[0_0_15px_rgba(0,212,212,0.3)]">
                <i class="fas fa-plus mr-2"></i> New Assessment
            </a>
        </div>
    </div>

    <!-- Top Charts Section (Requested First) -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
        <!-- Scan Activity Chart -->
        <div class="card relative overflow-hidden group">
            <div class="absolute top-0 left-0 w-1 h-full bg-primary opacity-50"></div>
            <div class="mb-6 flex justify-between items-center z-10 relative">
                <div>
                    <h3 class="text-lg font-semibold flex items-center gap-2">
                        <i class="fas fa-chart-area text-primary"></i> Activity Analysis
                    </h3>
                    <p class="text-xs text-gray-300 mt-1">30-day scan frequency trends</p>
                </div>
            <div class="badge badge--secondary font-mono text-xs">LIVE</div>
            </div>
            <div style="height: 240px; width: 100%; position: relative;">
                <canvas id="trendsChart"></canvas>
                {% if total_scans == 0 %}
                <div class="absolute inset-0 flex flex-col items-center justify-center bg-background/80 backdrop-blur-sm rounded-lg">
                    <i class="fas fa-chart-line text-3xl text-muted mb-3"></i>
                    <p class="text-gray-300 text-sm">Run your first scan to see activity</p>
                    <a href="{% url 'scanner:new_scan' %}" class="btn btn--primary btn--sm mt-3">
                        <i class="fas fa-plus mr-1"></i> New Scan
                    </a>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Severity Distribution Chart -->
        <div class="card relative overflow-hidden group">
            <div class="absolute top-0 left-0 w-1 h-full bg-destructive opacity-50"></div>
            <div class="mb-6 flex justify-between items-center z-10 relative">
                <div>
                    <h3 class="text-lg font-semibold flex items-center gap-2">
                        <i class="fas fa-chart-pie text-destructive"></i> Severity Distribution
                    </h3>
                    <p class="text-xs text-gray-300 mt-1">Current vulnerability landscape</p>
                </div>
                <div class="text-right">
                    <div class="text-2xl font-bold text-destructive">{{ risk_distribution.high|default:0 }}</div>
                    <div class="text-xs text-muted uppercase tracking-wider">Critical</div>
                </div>
            </div>
            <div style="height: 240px; display: flex; justify-content: center; position: relative;">
                <canvas id="riskChart"></canvas>
                <!-- Center Text for Donut -->
                <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                    <div class="text-center">
                        <div class="text-3xl font-bold">{{ total_scans|default:0 }}</div>
                        <div class="text-xs text-muted uppercase">Total</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- System Status & Stats Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
        <!-- Risk Score Card (Big Gauge Style) -->
        <div class="card bg-gradient-to-br from-card to-background border-primary/20 relative overflow-hidden">
            <div class="absolute -right-4 -top-4 w-24 h-24 bg-primary/10 rounded-full blur-2xl"></div>
            <div class="flex justify-between items-start mb-2">
                <span class="text-xs font-semibold text-primary uppercase tracking-wider">Security Score</span>
                <i class="fas fa-shield-alt text-primary/50"></i>
            </div>
            {% with security_score=risk_distribution.low|default:0 total_checks=total_scans|default:0 %}
            {% if total_checks > 0 %}
            <div class="mt-4 flex items-end gap-2">
                <span class="text-4xl font-bold text-foreground">{{ security_score|default:0 }}</span>
                <span class="text-sm text-muted mb-1 pb-1">/ {{ total_checks }}</span>
            </div>
            <div class="w-full bg-secondary h-1.5 mt-4 rounded-full overflow-hidden">
                <div class="bg-primary h-full rounded-full" style="width: {% widthratio security_score total_checks 100 %}%"></div>
            </div>
            <p class="text-xs text-muted mt-2">Passed {{ security_score }} of {{ total_checks }} checks</p>
            {% else %}
            <div class="mt-4 flex items-end gap-2">
                <span class="text-4xl font-bold text-foreground">--</span>
                <span class="text-sm text-muted mb-1 pb-1">/ 100</span>
            </div>
            <div class="w-full bg-secondary h-1.5 mt-4 rounded-full overflow-hidden">
                <div class="bg-primary/30 h-full rounded-full" style="width: 0%"></div>
            </div>
            <p class="text-xs text-muted mt-2">Run a scan to see your score</p>
            {% endif %}
            {% endwith %}
        </div>

        <!-- Critical Issues -->
        <div class="card border-l-4 border-l-destructive">
            <div class="flex justify-between items-start">
                <div>
                    <div class="text-xs font-semibold text-muted uppercase tracking-wider mb-1">Critical Issues</div>
                    <div class="text-3xl font-bold text-destructive">{{ risk_distribution.high|default:0 }}</div>
                </div>
                <div class="p-2 bg-destructive/10 rounded-lg text-destructive">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
            </div>
            <div class="mt-4 text-xs font-medium text-destructive flex items-center gap-1">
                <i class="fas fa-arrow-up"></i> Immediate action required
            </div>
        </div>

        <!-- Active Scans -->
        <div class="card border-l-4 border-l-primary/50">
            <div class="flex justify-between items-start">
                <div>
                    <div class="text-xs font-semibold text-muted uppercase tracking-wider mb-1">Passed Checks</div>
                    <div class="text-3xl font-bold text-foreground">{{ risk_distribution.low|default:0 }}</div>
                </div>
                <div class="p-2 bg-green-500/10 rounded-lg text-green-500">
                    <i class="fas fa-check-circle"></i>
                </div>
            </div>
            <div class="mt-4 text-xs font-medium text-green-500 flex items-center gap-1">
                <i class="fas fa-shield-check"></i> System functional
            </div>
        </div>

        <!-- Uptime / Latency Mock -->
        <div class="card">
            <div class="flex justify-between items-start mb-4">
                <div class="text-xs font-semibold text-muted uppercase tracking-wider">System Status</div>
                <div class="flex items-center gap-1.5">
                    <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                    <span class="text-xs font-medium text-green-500">ONLINE</span>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <div class="text-xs text-muted mb-1">Latency</div>
                    <div class="text-lg font-mono font-bold">24ms</div>
                </div>
                <div>
                    <div class="text-xs text-muted mb-1">Uptime</div>
                    <div class="text-lg font-mono font-bold">99.9%</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Recent Activity Table -->
    <div class="card">
        <div class="p-6 border-b border-border flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
             <div>
                <h3 class="text-lg font-semibold flex items-center gap-2">
                    <i class="fas fa-list text-primary"></i> Recent Assessments
                </h3>
                <p class="text-sm text-muted mt-1">Latest vulnerability scans and OSINT findings</p>
             </div>
             <div class="flex gap-2">
                 <div class="relative">
                     <input type="text" placeholder="Filter targets..." class="bg-background border rounded-md px-3 py-1.5 text-xs w-48 focus:border-primary outline-none">
                 </div>
                 <a href="{% url 'scanner:new_scan' %}" class="btn btn--outline btn--sm">View All</a>
             </div>
        </div>
        
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead>
                    <tr class="bg-muted/30">
                        <th class="px-6 py-3 text-left text-xs font-medium text-muted uppercase tracking-wider">Target</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-muted uppercase tracking-wider">Type</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-muted uppercase tracking-wider">Risk Score</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-muted uppercase tracking-wider">Date</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-muted uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-muted uppercase tracking-wider">Action</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-border">
                    {% for scan in recent_scans %}
                    <tr class="hover:bg-muted/20 transition-colors group cursor-pointer" onclick="window.location='{% url 'scanner:view_scan' scan.id %}'">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded bg-secondary flex items-center justify-center text-primary group-hover:bg-primary group-hover:text-black transition-colors">
                                    <i class="fas {% if scan.email %}fa-envelope{% elif scan.username %}fa-user{% elif scan.domain %}fa-globe{% else %}fa-search{% endif %} text-xs"></i>
                                </div>
                                <span class="text-sm font-medium font-mono text-foreground">
                                    {% if scan.name %}{{ scan.name }}{% elif scan.email %}{{ scan.email }}{% elif scan.username %}{{ scan.username }}{% elif scan.domain %}{{ scan.domain }}{% else %}Scan #{{ scan.id }}{% endif %}
                                </span>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-muted">Active OSINT</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center gap-2">
                                <div class="w-16 h-1.5 bg-secondary rounded-full overflow-hidden">
                                    <div class="h-full rounded-full {% if scan.risk_score <= 30 %}bg-green-500{% elif scan.risk_score <= 70 %}bg-yellow-500{% else %}bg-destructive{% endif %}" style="width: {{ scan.risk_score }}%"></div>
                                </div>
                                <span class="text-xs font-bold">{{ scan.risk_score }}</span>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-xs text-muted font-mono">{{ scan.created_at|date:"Y-m-d H:i" }}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="badge badge--outline text-xs bg-green-500/10 text-green-500 border-green-500/20">
                                <i class="fas fa-check mr-1"></i> Completed
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right">
                            <span class="text-muted group-hover:text-primary transition-colors text-sm"><i class="fas fa-chevron-right"></i></span>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="px-6 py-12 text-center text-muted">
                            <div class="flex flex-col items-center gap-3 opacity-50">
                                <i class="fas fa-wind text-4xl"></i>
                                <p class="text-sm">No assessments found in this timeline.</p>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>




<script>
document.addEventListener('DOMContentLoaded', function() {
    // Data from Django - using JSON script tags for proper parsing
    var riskData = {
        low: parseInt('{{ risk_distribution.low|default:0 }}') || 0,
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // ===== CHART.JS INITIALIZATION =====
    
    // Check if Chart.js is loaded
    if (typeof Chart === 'undefined') {
        console.error('[VULNRIX] Chart.js library not loaded!');
        return;
    }

    // Risk Distribution Data
    var riskData = {
        low: parseInt('{{ risk_distribution.low|default:0 }}') || 0,
        medium: parseInt('{{ risk_distribution.medium|default:0 }}') || 0,
        high: parseInt('{{ risk_distribution.high|default:0 }}') || 0
    };
    
    // Risk Distribution Doughnut Chart
    var riskCanvas = document.getElementById('riskChart');
    if (riskCanvas) {
        var hasData = riskData.low > 0 || riskData.medium > 0 || riskData.high > 0;
        try {
            new Chart(riskCanvas.getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: ['Low', 'Medium', 'High'],
                    datasets: [{
                        data: hasData ? [riskData.low, riskData.medium, riskData.high] : [0, 0, 1], // Default to empty state if no data
                        backgroundColor: hasData ? ['#10b981', '#f59e0b', '#ef4444'] : ['#2a2a35', '#2a2a35', '#2a2a35'], // Dark grey for empty
                        borderColor: '#0a0a0f',
                        borderWidth: 3,
                        hoverOffset: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%',
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { 
                                color: '#ffffff', // Force White
                                padding: 15, 
                                font: { size: 11, family: "'JetBrains Mono', monospace" }, 
                                usePointStyle: true,
                                boxWidth: 8
                            }
                        },
                        tooltip: {
                            enabled: hasData, // Disable tooltip if no data
                            backgroundColor: '#1a1a24',
                            titleColor: '#00d4d4',
                            bodyColor: '#ffffff',
                            borderColor: '#2a2a3a',
                            borderWidth: 1
                        }
                    }
                }
            });
        } catch (e) { console.error('[VULNRIX] Risk chart render error:', e); }
    }
    
    // Scan Trends Line Chart
    var trendsCanvas = document.getElementById('trendsChart');
    if (trendsCanvas) {
        var labels = [];
        var data = [];
        
        // Parse real trends data from Django
        {% if exposure_trends %}
        try {
            var trendsRaw = {{ exposure_trends|safe }};
            if (trendsRaw && Array.isArray(trendsRaw) && trendsRaw.length > 0) {
                // Use last 7 entries for display
                var recentTrends = trendsRaw.slice(-7);
                labels = recentTrends.map(function(d) { 
                    if (d.date) {
                        var parts = d.date.split('-');
                        return parts.length > 2 ? parts[1] + '/' + parts[2] : d.date;
                    }
                    return '';
                });
                data = recentTrends.map(function(d) { return d.count || 0; });
            }
        } catch(e) { console.error('[VULNRIX] Trends data parse error:', e); }
        {% endif %}
        
        // If no data, show empty state
        if (data.length === 0) {
            labels = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            data = [0, 0, 0, 0, 0, 0, 0];
        }

        try {
            new Chart(trendsCanvas.getContext('2d'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Scans',
                        data: data,
                        borderColor: '#00d4d4',
                        backgroundColor: 'rgba(0, 212, 212, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: '#00d4d4',
                        pointBorderColor: '#0a0a0f',
                        pointBorderWidth: 2,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: '#1a1a24',
                            titleColor: '#00d4d4',
                            bodyColor: '#ffffff',
                            borderColor: '#2a2a3a',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: '#9ca3af', stepSize: 1, font: { size: 10 } },
                            grid: { color: 'rgba(255, 255, 255, 0.05)' },
                            border: { display: false }
                        },
                        x: {
                            ticks: { color: '#9ca3af', font: { size: 10 } },
                            grid: { display: false },
                            border: { display: false }
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });
        } catch (e) { console.error('[VULNRIX] Trends chart render error:', e); }
    }
    
    // ===== LIVE UPDATE POLLING =====
    function refreshDashboardStats() {
        fetch('/api/stats/')
            .then(function(res) { 
                if (!res.ok) throw new Error('API response not ok');
                return res.json(); 
            })
            .then(function(data) {
                // Update trends chart
                var trendsChart = Chart.getChart('trendsChart');
                if (trendsChart && data.exposure_trends && data.exposure_trends.length > 0) {
                    trendsChart.data.labels = data.exposure_trends.map(function(d) { return d.label; });
                    trendsChart.data.datasets[0].data = data.exposure_trends.map(function(d) { return d.count; });
                    trendsChart.update('none');
                }
                
                // Flash LIVE badge
                var liveBadge = document.querySelector('.badge--secondary');
                if (liveBadge) {
                    liveBadge.classList.add('animate-pulse');
                    setTimeout(function() { liveBadge.classList.remove('animate-pulse'); }, 1000);
                }
            })
            .catch(function(err) {
                // Silently fail on network errors in dev environment to avoid console spam
                // console.log('[VULNRIX] Stats refresh error:', err);
            });
    }
    
    // Poll every 30 seconds for live updates
    setInterval(refreshDashboardStats, 30000);
    
    // Refresh on visibility change
    document.addEventListener('visibilitychange', function() {
        if (!document.hidden) refreshDashboardStats();
    });
});
</script>
{% endblock %}
