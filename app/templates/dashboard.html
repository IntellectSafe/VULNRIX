{% extends "base.html" %}

{% block title %}Dashboard - VULNRIX{% endblock %}

{% block content %}
<div class="hacker-theme min-h-screen p-6 relative">
    <div class="scanline"></div>
    <div class="container mx-auto">
        <!-- Header -->
        <div class="flex justify-between items-end mb-8 border-b border-green-500/30 pb-4">
            <div>
                <h1 class="text-3xl font-bold tracking-tight mb-1 glitch" data-text="DIGITAL FOOTPRINT">
                    <i class="fas fa-user-secret mr-2"></i>DIGITAL_FOOTPRINT
                </h1>
                <p class="text-gray-400 font-mono text-xs">> MONITORING_TARGETS_ACTIVE</p>
            </div>
        <div class="flex gap-3">
            <button class="btn btn--outline" onclick="window.location.reload()">
                <i class="fas fa-sync-alt mr-2"></i> Refresh
            </button>
            <a href="{% url 'scanner:new_scan' %}" class="btn btn--primary shadow-[0_0_15px_rgba(0,212,212,0.3)]">
                <i class="fas fa-plus mr-2"></i> New Assessment
            </a>
        </div>
    </div>

    <!-- Top Charts Section (HACKER THEME) -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8 font-mono">
        <!-- Scan Activity Chart -->
        <div class="border border-green-500/30 bg-black p-0 relative overflow-hidden group shadow-[0_0_15px_rgba(0,0,0,0.5)]">
            <div class="p-4 border-b border-green-900 bg-green-900/10 flex justify-between items-center">
                <div>
                    <h3 class="text-sm font-bold text-green-500 uppercase tracking-wider flex items-center gap-2">
                        <i class="fas fa-wave-square"></i> SIGNAL_ACTIVITY_FREQ
                    </h3>
                </div>
                <div class="text-[10px] text-green-400 animate-pulse border border-green-500 px-2 py-0.5">LIVE_MONITOR</div>
            </div>
            
            <div class="p-4 relative" style="height: 240px; width: 100%;">
                <canvas id="trendsChart"></canvas>
                {% if total_scans == 0 %}
                <div class="absolute inset-0 flex flex-col items-center justify-center bg-black/80 backdrop-blur-sm">
                    <i class="fas fa-satellite-dish text-3xl text-green-900 mb-3 animate-pulse"></i>
                    <p class="text-green-700 text-xs font-mono uppercase">NO_SIGNAL_DETECTED</p>
                    <a href="{% url 'scanner:new_scan' %}" class="mt-3 border border-green-500 text-green-500 px-4 py-2 text-xs hover:bg-green-500 hover:text-black transition-all font-bold">
                        INITIATE_FIRST_SEQ
                    </a>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Severity Distribution Chart -->
        <div class="border border-green-500/30 bg-black p-0 relative overflow-hidden group shadow-[0_0_15px_rgba(0,0,0,0.5)]">
            <div class="p-4 border-b border-green-900 bg-green-900/10 flex justify-between items-center">
                <div>
                    <h3 class="text-sm font-bold text-green-500 uppercase tracking-wider flex items-center gap-2">
                        <i class="fas fa-chart-pie"></i> THREAT_DISTRIBUTION_MATRIX
                    </h3>
                </div>
                <div class="text-right">
                    <div class="text-xl font-bold text-red-500 leading-none">{{ risk_distribution.high|default:0 }}</div>
                    <div class="text-[9px] text-green-800 uppercase tracking-wider">CRITICAL_VULNS</div>
                </div>
            </div>
            <div class="p-4 flex justify-center relative" style="height: 240px;">
                <canvas id="riskChart"></canvas>
                <!-- Center Text for Donut -->
                <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                    <div class="text-center">
                        <div class="text-3xl font-bold text-green-400 font-mono">{{ total_scans|default:0 }}</div>
                        <div class="text-[10px] text-green-800 uppercase font-mono">TOTAL_OPS</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- System Status & Stats Grid (HACKER THEME) -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8 font-mono">
        <!-- Risk Score Card (Big Gauge Style) -->
        <div class="border border-green-500/30 bg-black p-4 relative overflow-hidden group hover:border-green-500/60 transition-colors">
            <div class="absolute -right-4 -top-4 w-24 h-24 bg-green-500/5 rounded-full blur-xl"></div>
            <div class="flex justify-between items-start mb-2">
                <span class="text-[10px] font-bold text-green-600 uppercase tracking-wider">NET_SECURITY_INTEGRITY</span>
                <i class="fas fa-shield-alt text-green-800"></i>
            </div>
            {% with security_score=risk_distribution.low|default:0 total_checks=total_scans|default:0 %}
            {% if total_checks > 0 %}
            <div class="mt-4 flex items-end gap-2">
                <span class="text-3xl font-bold text-green-400">{{ security_score }}</span>
                <span class="text-xs text-green-800 mb-1 pb-1">/ {{ total_checks }} PASSED</span>
            </div>
            <div class="w-full bg-green-900/20 h-1 mt-4 rounded-full overflow-hidden">
                <div class="bg-green-500 h-full shadow-[0_0_5px_#0f0]" style="width: {% widthratio security_score total_checks 100 %}%"></div>
            </div>
            {% else %}
            <div class="mt-4 flex items-end gap-2">
                <span class="text-3xl font-bold text-green-900">--</span>
                <span class="text-xs text-green-900 mb-1 pb-1">/ NIL</span>
            </div>
            <div class="w-full bg-green-900/10 h-1 mt-4"></div>
            <p class="text-[10px] text-green-700 mt-2">> AWAITING_FIRST_SCAN</p>
            {% endif %}
            {% endwith %}
        </div>

        <!-- Critical Issues -->
        <div class="border border-red-900/50 bg-black p-4 relative overflow-hidden group hover:border-red-500/50 transition-colors">
            <div class="flex justify-between items-start">
                <div>
                    <div class="text-[10px] font-bold text-red-900 uppercase tracking-wider mb-1">CRITICAL_VULNERABILITIES</div>
                    <div class="text-3xl font-bold text-red-500 glitch" data-text="{{ risk_distribution.high|default:0 }}">{{ risk_distribution.high|default:0 }}</div>
                </div>
                <div class="p-2 border border-red-900 bg-red-900/10 text-red-500">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
            </div>
            <div class="mt-4 text-[10px] font-medium text-red-700 flex items-center gap-1 uppercase">
                <i class="fas fa-bolt"></i> Immediate_Remediation_Req
            </div>
        </div>

        <!-- Active Scans -->
        <div class="border border-green-500/30 bg-black p-4 relative overflow-hidden group hover:border-green-500/60 transition-colors">
            <div class="flex justify-between items-start">
                <div>
                    <div class="text-[10px] font-bold text-green-700 uppercase tracking-wider mb-1">CLEAN_SECTORS</div>
                    <div class="text-3xl font-bold text-green-400">{{ risk_distribution.low|default:0 }}</div>
                </div>
                <div class="p-2 border border-green-900 bg-green-900/10 text-green-500">
                    <i class="fas fa-check-circle"></i>
                </div>
            </div>
            <div class="mt-4 text-[10px] font-medium text-green-700 flex items-center gap-1 uppercase">
                <i class="fas fa-shield-check"></i> System_Stable
            </div>
        </div>

        <!-- Uptime / Latency Mock -->
        <div class="border border-green-500/30 bg-black p-4 relative overflow-hidden group">
            <div class="flex justify-between items-start mb-4">
                <div class="text-[10px] font-bold text-green-600 uppercase tracking-wider">SYSTEM_TELEMETRY</div>
                <div class="flex items-center gap-1.5">
                    <span class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></span>
                    <span class="text-[9px] font-medium text-green-500 tracking-widest">ONLINE</span>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <div class="text-[9px] text-green-800 mb-1 uppercase">Ping_Latency</div>
                    <div class="text-lg font-mono font-bold text-green-400">24ms</div>
                </div>
                <div>
                    <div class="text-[9px] text-green-800 mb-1 uppercase">Uptime_Stats</div>
                    <div class="text-lg font-mono font-bold text-green-400">99.9%</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- OPERATION LOGS (Hacker Style) -->
    <div class="hacker-panel border border-green-500/30 bg-black p-0 relative overflow-hidden group mb-8">
        <div class="absolute inset-0 bg-[url('https://media.giphy.com/media/U3qYN8S0j3bpK/giphy.gif')] opacity-[0.02] pointer-events-none"></div>
        <div class="p-4 border-b border-green-500/30 flex justify-between items-center bg-green-900/10">
            <h3 class="text-xl font-bold text-green-400 font-mono tracking-wider glitch" data-text="OPERATION_LOGS">
                <i class="fas fa-terminal mr-2"></i>OPERATION_LOGS
            </h3>
            <div class="flex gap-4 items-center">
                <span class="text-xs text-green-700 font-mono animate-pulse">LIVE_FEED_ACTIVE</span>
                <a href="{% url 'scanner:new_scan' %}" class="btn btn--primary btn--sm border border-green-500 text-green-500 hover:bg-green-500 hover:text-black font-mono text-xs uppercase tracking-wider">
                    NEW_OP
                </a>
            </div>
        </div>
        
        <div class="overflow-x-auto">
            <table class="w-full text-left font-mono text-sm">
                <thead class="bg-green-900/20 text-green-500 uppercase tracking-widest text-xs border-b border-green-500/30">
                    <tr>
                        <th class="p-4 font-normal">Target_ID</th>
                        <th class="p-4 font-normal">Type</th>
                        <th class="p-4 font-normal">Threat_Assessment</th>
                        <th class="p-4 font-normal">Timestamp</th>
                        <th class="p-4 font-normal text-right">Access_Log</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-green-900/30">
                    {% for scan in recent_scans %}
                    <tr class="hover:bg-green-900/10 transition-colors group/row cursor-pointer" onclick="window.location='{% url 'scanner:view_scan' scan.id %}'">
                        <td class="p-4 font-bold text-green-400 group-hover/row:text-green-300 transition-colors">
                            <div class="flex items-center gap-2">
                                <span class="opacity-50 text-[10px]">></span>
                                {% if scan.name %}{{ scan.name }}
                                {% elif scan.email %}{{ scan.email }}
                                {% elif scan.username %}{{ scan.username }}
                                {% elif scan.domain %}{{ scan.domain }}
                                {% elif scan.ip %}{{ scan.ip }}
                                {% elif scan.phone %}{{ scan.phone }}
                                {% else %}UNKNOWN_TARGET{% endif %}
                            </div>
                        </td>
                        <td class="p-4 text-green-600 text-xs uppercase">
                            {% if scan.domain or scan.ip %}INFRASTRUCTURE{% else %}IDENTITY_DIGITAL{% endif %}
                        </td>
                        <td class="p-4">
                            {% if scan.risk_score >= 70 %}
                                <span class="text-red-500 font-bold glitch-hover">CRITICAL [{{ scan.risk_score }}%]</span>
                            {% elif scan.risk_score >= 30 %}
                                <span class="text-yellow-500">WARNING [{{ scan.risk_score }}%]</span>
                            {% else %}
                                <span class="text-green-700">STABLE [{{ scan.risk_score }}%]</span>
                            {% endif %}
                        </td>
                        <td class="p-4 text-green-800 text-xs">
                            {{ scan.created_at|date:"Y-m-d H:i:s" }}
                        </td>
                        <td class="p-4 text-right">
                            <span class="text-green-800 group-hover/row:text-green-500 transition-colors">[ VIEW_REPORT ]</span>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="p-8 text-center text-green-900 italic border-t border-green-900/30">
                            > NO_OPERATIONS_RECORDED_IN_THIS_SECTOR
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>




<script>
document.addEventListener('DOMContentLoaded', function() {
    // Data from Django - using JSON script tags for proper parsing
    var riskData = {
        low: parseInt('{{ risk_distribution.low|default:0 }}') || 0,
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // ===== CHART.JS INITIALIZATION =====
    
    // Check if Chart.js is loaded
    if (typeof Chart === 'undefined') {
        console.error('[VULNRIX] Chart.js library not loaded!');
        return;
    }

    // Risk Distribution Data
    var riskData = {
        low: parseInt('{{ risk_distribution.low|default:0 }}') || 0,
        medium: parseInt('{{ risk_distribution.medium|default:0 }}') || 0,
        high: parseInt('{{ risk_distribution.high|default:0 }}') || 0
    };
    
    // Risk Distribution Doughnut Chart
    var riskCanvas = document.getElementById('riskChart');
    if (riskCanvas) {
        var hasData = riskData.low > 0 || riskData.medium > 0 || riskData.high > 0;
        try {
            new Chart(riskCanvas.getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: ['Low', 'Medium', 'High'],
                    datasets: [{
                        data: hasData ? [riskData.low, riskData.medium, riskData.high] : [0, 0, 1], // Default to empty state if no data
                        backgroundColor: hasData ? ['#10b981', '#f59e0b', '#ef4444'] : ['#2a2a35', '#2a2a35', '#2a2a35'], // Dark grey for empty
                        borderColor: '#0a0a0f',
                        borderWidth: 3,
                        hoverOffset: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%',
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { 
                                color: '#ffffff', // Force White
                                padding: 15, 
                                font: { size: 11, family: "'JetBrains Mono', monospace" }, 
                                usePointStyle: true,
                                boxWidth: 8
                            }
                        },
                        tooltip: {
                            enabled: hasData, // Disable tooltip if no data
                            backgroundColor: '#1a1a24',
                            titleColor: '#00d4d4',
                            bodyColor: '#ffffff',
                            borderColor: '#2a2a3a',
                            borderWidth: 1
                        }
                    }
                }
            });
        } catch (e) { console.error('[VULNRIX] Risk chart render error:', e); }
    }
    
    // Scan Trends Line Chart
    var trendsCanvas = document.getElementById('trendsChart');
    if (trendsCanvas) {
        var labels = [];
        var data = [];
        
        // Parse real trends data from Django
        {% if exposure_trends %}
        try {
            var trendsRaw = {{ exposure_trends|safe }};
            if (trendsRaw && Array.isArray(trendsRaw) && trendsRaw.length > 0) {
                // Use last 7 entries for display
                var recentTrends = trendsRaw.slice(-7);
                labels = recentTrends.map(function(d) { 
                    if (d.date) {
                        var parts = d.date.split('-');
                        return parts.length > 2 ? parts[1] + '/' + parts[2] : d.date;
                    }
                    return '';
                });
                data = recentTrends.map(function(d) { return d.count || 0; });
            }
        } catch(e) { console.error('[VULNRIX] Trends data parse error:', e); }
        {% endif %}
        
        // If no data, show empty state
        if (data.length === 0) {
            labels = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            data = [0, 0, 0, 0, 0, 0, 0];
        }

        try {
            new Chart(trendsCanvas.getContext('2d'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Scans',
                        data: data,
                        borderColor: '#00ff00',  /* Neon Green */
                        backgroundColor: 'rgba(0, 255, 0, 0.1)',
                        borderWidth: 2,
                        tension: 0.2, /* More robotic/sharp */
                        fill: true,
                        pointBackgroundColor: '#00ff00',
                        pointBorderColor: '#000',
                        pointBorderWidth: 1,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: '#1a1a24',
                            titleColor: '#00d4d4',
                            bodyColor: '#ffffff',
                            borderColor: '#2a2a3a',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: '#9ca3af', stepSize: 1, font: { size: 10 } },
                            grid: { color: 'rgba(255, 255, 255, 0.05)' },
                            border: { display: false }
                        },
                        x: {
                            ticks: { color: '#9ca3af', font: { size: 10 } },
                            grid: { display: false },
                            border: { display: false }
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });
        } catch (e) { console.error('[VULNRIX] Trends chart render error:', e); }
    }
    
    // ===== LIVE UPDATE POLLING =====
    function refreshDashboardStats() {
        fetch('/api/stats/')
            .then(function(res) { 
                if (!res.ok) throw new Error('API response not ok');
                return res.json(); 
            })
            .then(function(data) {
                // Update trends chart
                var trendsChart = Chart.getChart('trendsChart');
                if (trendsChart && data.exposure_trends && data.exposure_trends.length > 0) {
                    trendsChart.data.labels = data.exposure_trends.map(function(d) { return d.label; });
                    trendsChart.data.datasets[0].data = data.exposure_trends.map(function(d) { return d.count; });
                    trendsChart.update('none');
                }
                
                // Flash LIVE badge
                var liveBadge = document.querySelector('.badge--secondary');
                if (liveBadge) {
                    liveBadge.classList.add('animate-pulse');
                    setTimeout(function() { liveBadge.classList.remove('animate-pulse'); }, 1000);
                }
            })
            .catch(function(err) {
                // Silently fail on network errors in dev environment to avoid console spam
                // console.log('[VULNRIX] Stats refresh error:', err);
            });
    }
    
    // Poll every 30 seconds for live updates
    setInterval(refreshDashboardStats, 30000);
    
    // Refresh on visibility change
    document.addEventListener('visibilitychange', function() {
        if (!document.hidden) refreshDashboardStats();
    });
});
</script>
{% endblock %}
