{% extends "base.html" %}
{% load static %}

{% block title %}Code Scanner - VULNRIX{% endblock %}

{% block extra_head %}
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">
<style>
    /* Terminal Output Styles */
    .terminal-window {
        background-color: #1e1e1e;
        border: 1px solid #333;
        border-radius: 0.5rem;
        font-family: 'JetBrains Mono', monospace;
        color: #cccccc;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        height: 350px;
    }
    .terminal-header {
        background-color: #252526;
        padding: 0.5rem 1rem;
        border-bottom: 1px solid #333;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.75rem;
        color: #999;
    }
    .terminal-body {
        flex: 1;
        padding: 1rem;
        overflow-y: auto;
    }
    .terminal-body::-webkit-scrollbar { width: 8px; }
    .terminal-body::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }
    .terminal-body::-webkit-scrollbar-track { background: transparent; }
    
    .log-line { margin-bottom: 0.25rem; font-size: 0.8rem; line-height: 1.4; word-break: break-all; }
    .log-info { color: #cccccc; }
    .log-error { color: #f43f5e; font-weight: bold; }
    .log-success { color: #10b981; }
    .log-warn { color: #f59e0b; }
    .log-snyk { color: #a78bfa; } /* Light purple for Snyk */
    .log-time { color: #666; margin-right: 0.5rem; font-size: 0.7rem; }

    /* Tab Customization */
    .tab-btn.active {
        background-color: hsl(var(--primary));
        color: hsl(var(--primary-foreground));
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto max-w-7xl pb-10 px-4">
    <!-- Header -->
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-6 pt-6">
        <div>
            <div class="flex items-center gap-3 mb-2">
                <div class="p-3 bg-teal-500/10 rounded-lg text-teal-500">
                    <i class="fas fa-file-code text-2xl"></i>
                </div>
                <div>
                    <h1 class="text-3xl font-bold tracking-tight">Code Scanner</h1>
                    <p class="text-muted text-sm">Static Analysis & Vulnerability Detection</p>
                </div>
            </div>
        </div>
        
        <!-- Scan Mode Selector -->
        <div class="flex bg-muted p-1 rounded-lg" role="group">
            <button class="px-4 py-2 text-xs font-bold uppercase rounded-md transition-all hover:text-white text-muted-foreground" 
                onclick="setMode('fast')" id="btn-fast" data-state="inactive">
                <i class="fas fa-bolt mr-2"></i> Fast
            </button>
            <button class="px-4 py-2 text-xs font-bold uppercase rounded-md transition-all bg-teal-600 text-white shadow-sm" 
                onclick="setMode('hybrid')" id="btn-hybrid" data-state="active">
                <i class="fas fa-balance-scale mr-2"></i> Hybrid
            </button>
        </div>
    </div>
    
    <!-- Stats Cards -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
        <div class="card p-4 border border-border bg-card">
            <p class="text-xs text-muted uppercase tracking-wider mb-1">System Status</p>
            <div class="flex items-center gap-2 text-teal-500 font-medium text-sm">
                <span class="relative flex h-2 w-2">
                  <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-teal-500 opacity-75"></span>
                  <span class="relative inline-flex rounded-full h-2 w-2 bg-teal-500"></span>
                </span>
                ONLINE
            </div>
        </div>
        <div class="card p-4 border border-border bg-card">
            <p class="text-xs text-muted uppercase tracking-wider mb-1">Security Grade</p>
            <div class="flex items-baseline gap-2">
                <span class="text-2xl font-bold {% if security_grade == 'A' %}text-green-500{% elif security_grade == 'B' %}text-teal-500{% elif security_grade == 'C' %}text-yellow-500{% elif security_grade == 'D' %}text-orange-500{% else %}text-red-500{% endif %}" id="statGrade">
                    {% if security_grade %}{{ security_grade }}{% else %}-{% endif %}
                </span>
                <span class="text-xs text-muted font-mono" id="statScore">
                    {% if security_score %}{{ security_score }}%{% else %}0%{% endif %}
                </span>
            </div>
            <div class="text-[10px] text-muted mt-1" id="statDate">
                {% if last_scan %}{{ last_scan.created_at|date:"M d, H:i" }}{% else %}No scans yet{% endif %}
            </div>
        </div>
        <div class="card p-4 border border-border bg-card">
            <p class="text-xs text-muted uppercase tracking-wider mb-1">Issues Found</p>
            <div class="font-bold text-lg text-teal-500" id="statIssues">
                {% if last_scan %}{{ last_scan.total_findings }}{% else %}0{% endif %}
            </div>
        </div>
        <div class="card p-4 border border-border bg-card">
            <p class="text-xs text-muted uppercase tracking-wider mb-1">Files Scanned</p>
            <div class="font-bold text-lg text-foreground">
                {% if project_history %}{{ project_history.0.total_files }}{% else %}1{% endif %}
            </div>
        </div>
    </div>
    
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Main Scanner Area (Control Panel) -->
        <div class="lg:col-span-2 space-y-6">
            
            <!-- Input Card -->
            <div class="card border border-border bg-card overflow-hidden">
                <div class="flex border-b border-border">
                    <button class="flex-1 py-3 text-sm font-medium border-b-2 border-teal-500 text-teal-500 transition-colors" id="tab-file" onclick="switchTab('file')">
                        <i class="fas fa-file mr-2"></i> File / Zip
                    </button>
                    <button class="flex-1 py-3 text-sm font-medium border-b-2 border-transparent text-muted-foreground hover:text-foreground transition-colors" id="tab-repo" onclick="switchTab('repo')">
                        <i class="fab fa-github mr-2"></i> Git Repo
                    </button>
                    <button class="flex-1 py-3 text-sm font-medium border-b-2 border-transparent text-muted-foreground hover:text-foreground transition-colors" id="tab-github" onclick="switchTab('github')">
                        <i class="fas fa-plug mr-2"></i> Connect GitHub
                    </button>
                </div>
                
                <div class="p-6">
                    <!-- FILE / ZIP UPLOAD -->
                    <div id="panel-file" class="block">
                        <div class="border-2 border-dashed border-border hover:border-teal-500/50 transition-colors rounded-xl p-10 text-center cursor-pointer bg-muted/20 group relative" 
                             id="dropZone">
                            <input type="file" id="fileInput" class="hidden" accept=".py,.js,.ts,.jsx,.tsx,.java,.go,.php,.rb,.c,.cpp,.h,.hpp,.cs,.swift,.kt,.rs,.sql,.sh,.yaml,.yml,.json,.xml,.html,.vue,.zip">
                            
                            <div class="w-16 h-16 bg-background rounded-full flex items-center justify-center mx-auto mb-4 shadow-sm group-hover:scale-110 transition-transform duration-300">
                                <i class="fas fa-cloud-upload-alt text-2xl text-teal-500"></i>
                            </div>
                            <h3 class="text-lg font-semibold mb-1">Drop Source Code or Zip</h3>
                            <p class="text-muted text-sm mb-4">Click to browse or drag file here</p>
                            
                            <div class="flex flex-wrap justify-center gap-2 mt-2">
                                <span class="bg-zinc-800 text-zinc-400 px-2 py-1 rounded text-xs font-mono">Python</span>
                                <span class="bg-zinc-800 text-zinc-400 px-2 py-1 rounded text-xs font-mono">JS/TS</span>
                                <span class="bg-zinc-800 text-zinc-400 px-2 py-1 rounded text-xs font-mono">Java</span>
                                <span class="bg-zinc-800 text-zinc-400 px-2 py-1 rounded text-xs font-mono">C/C++</span>
                                <span class="bg-zinc-800 text-zinc-400 px-2 py-1 rounded text-xs font-mono">Go</span>
                                <span class="bg-zinc-800 text-zinc-400 px-2 py-1 rounded text-xs font-mono">Rust</span>
                                <span class="bg-zinc-800 text-zinc-400 px-2 py-1 rounded text-xs font-mono">PHP</span>
                                <span class="bg-teal-500/10 text-teal-500 px-2 py-1 rounded text-xs font-medium border border-teal-500/20">+ many more</span>
                            </div>
                        </div>
                    </div>
                    
                     <!-- REPO INPUT -->
                    <div id="panel-repo" class="hidden">
                        <div class="flex flex-col gap-4">
                            <label class="text-sm font-medium text-muted-foreground">Git Repository URL</label>
                            <div class="flex gap-2">
                                <input type="text" id="repoUrl" placeholder="https://github.com/username/repo.git" 
                                       class="flex-1 bg-background border border-border rounded-md px-3 py-2 text-sm focus:outline-none focus:border-teal-500 font-mono text-zinc-300">
                                <button onclick="startRepoScan()" class="btn bg-teal-600 hover:bg-teal-700 text-white font-medium px-6 py-2 rounded-md transition-colors">
                                    <i class="fas fa-search mr-2"></i> Scan Repo
                                </button>
                            </div>
                            <p class="text-xs text-muted">Supports public GitHub, GitLab, and Bitbucket repositories.</p>
                        </div>
                    </div>
                    
                    <!-- GITHUB APP CONNECT -->
                    <div id="panel-github" class="hidden">
                        <div id="github-loading" class="flex items-center justify-center py-8">
                            <i class="fas fa-spinner fa-spin text-2xl text-muted"></i>
                        </div>
                        
                        <!-- Not Connected State -->
                        <div id="github-not-connected" class="hidden flex flex-col items-center text-center py-6">
                            <div class="w-20 h-20 bg-zinc-900 rounded-full flex items-center justify-center mb-4 border border-zinc-700">
                                <i class="fab fa-github text-4xl text-white"></i>
                            </div>
                            <h3 class="text-lg font-semibold mb-2">Connect Your GitHub</h3>
                            <p class="text-muted text-sm mb-6 max-w-md">
                                Install the VULNRIX GitHub App to enable automatic PR security reviews, 
                                push-triggered scans, and AI-powered dependency fix PRs.
                            </p>
                            <a href="https://github.com/apps/vulnrix/installations/new" 
                               target="_blank"
                               class="btn bg-white text-black hover:bg-zinc-200 font-medium px-6 py-3 rounded-lg transition-all flex items-center justify-center gap-2">
                                <i class="fab fa-github"></i>
                                Install VULNRIX App
                            </a>
                        </div>
                        
                        <!-- Connected State -->
                        <div id="github-connected" class="hidden">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-semibold flex items-center gap-2">
                                    <i class="fas fa-check-circle text-green-500"></i>
                                    Connected Repositories
                                </h3>
                                <a href="https://github.com/apps/vulnrix/installations/new" 
                                   target="_blank"
                                   class="text-xs text-teal-500 hover:underline">
                                    + Add More Repos
                                </a>
                            </div>
                            
                            <div id="github-repos-list" class="space-y-2 max-h-64 overflow-y-auto">
                                <!-- Repos loaded dynamically -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Terminal Results -->
            <div class="terminal-window shadow-xl">
                <div class="terminal-header">
                    <span class="font-bold flex items-center gap-2"><i class="fas fa-terminal"></i> VULNRIX ENGINE OUT</span>
                    <span id="scanStatus" class="uppercase tracking-wider">IDLE</span>
                </div>
                    <!-- Progress Bar -->
                    <div id="scanProgressContainer" class="hidden mb-4">
                        <div class="flex justify-between text-xs text-green-400 mb-1 font-mono">
                            <span id="scanProgressText">SCANNING...</span>
                            <span id="scanProgressPercent">0%</span>
                        </div>
                        <div class="w-full bg-gray-900 rounded-full h-2.5 border border-green-900">
                            <div id="scanProgressBar" class="bg-green-500 h-2.5 rounded-full transition-all duration-300 shadow-[0_0_10px_rgba(34,197,94,0.5)]" style="width: 0%"></div>
                        </div>
                    </div>

                    <!-- Terminal Log -->
                    <div id="terminalLog" class="bg-black/90 font-mono text-sm p-4 rounded-lg h-96 overflow-y-auto border border-green-500/30 shadow-[inset_0_0_20px_rgba(0,0,0,0.8)] custom-scrollbar">
                        <div class="text-green-500 mb-2">root@vulnrix:~# ./scan_target.sh</div>
                        <div class="log-line log-info">> System Init... OK</div>
                        <div class="log-line log-info">> Ready for analysis.</div>
                    </div>
            </div>

        </div>

         <!-- Right Sidebar: History -->
        <div class="lg:col-span-1 space-y-6">
            <div class="card p-0 border border-border bg-card overflow-hidden">
                <div class="p-4 border-b border-border bg-muted/30 flex justify-between items-center">
                    <h3 class="font-bold text-sm uppercase tracking-wide text-muted-foreground">Recent Scans</h3>
                    <button class="text-xs text-teal-500 hover:underline">View All</button>
                </div>
                <div class="divide-y divide-border/50 max-h-[600px] overflow-y-auto">
                    {% for item in combined_history %}
                    <div class="p-3 hover:bg-muted/30 transition-colors cursor-pointer group" onclick="loadHistoryItem('{{ item.id }}', '{{ item.type }}')">
                        <div class="flex justify-between items-start mb-1">
                            <div class="flex items-center gap-2 overflow-hidden">
                                <i class="fas {% if item.type == 'file' %}fa-file-code{% else %}fa-project-diagram{% endif %} text-xs text-muted-foreground"></i>
                                <span class="text-sm font-medium text-foreground truncate">{{ item.name }}</span>
                            </div>
                            <span class="text-[10px] font-bold px-1.5 py-0.5 rounded {% if item.status == 'SAFE' %}bg-teal-500/10 text-teal-500{% else %}bg-rose-500/10 text-rose-500{% endif %}">
                                {{ item.status }}
                            </span>
                        </div>
                        <div class="flex justify-between items-center text-xs text-zinc-500">
                             <span>{{ item.created_at|date:"M d, H:i" }}</span>
                             <span>{{ item.detail }}</span>
                        </div>
                    </div>
                    {% empty %}
                    <div class="p-6 text-center text-muted text-sm">No scans yet.</div>
                    {% endfor %}
                </div>
            </div>
            
            <div class="card p-4 border-2 border-dashed border-border bg-transparent text-center">
                 <p class="text-sm text-muted">Need help? Check the <a href="{% url 'docs' %}" class="text-teal-500 hover:underline">Documentation</a>.</p>
            </div>
        </div>
    </div>

    <!-- FULL-WIDTH ANALYSIS REPORT (Outside Grid) -->
    <div id="detailReport" class="hidden mt-8 bg-[#1a1a1a] border border-[#333] rounded-lg overflow-hidden animate-in fade-in duration-500">
        <div class="bg-[#252526] px-4 py-3 border-b border-[#333] flex justify-between items-center">
            <h3 class="font-mono text-sm text-gray-400">ANALYSIS REPORT</h3>
            <button onclick="document.getElementById('detailReport').classList.add('hidden')" class="text-xs text-gray-500 hover:text-white">CLOSE</button>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full text-left border-collapse">
                <thead>
                    <tr class="text-xs text-gray-500 uppercase font-mono border-b border-[#333]">
                        <th class="p-3 w-24">Severity</th>
                        <th class="p-3 w-56">Type</th>
                        <th class="p-3 w-64">File</th>
                        <th class="p-3 w-16">Line</th>
                        <th class="p-3">Description</th>
                    </tr>
                </thead>
                <tbody id="findingsTableBody" class="text-sm font-mono text-gray-300">
                    <!-- Populated via JS -->
                </tbody>
            </table>
        </div>
    </div>
</div>

{% csrf_token %}
{% endblock %}

{% block scripts %}
<script>
// --- CONFIG ---
const term = document.getElementById('terminalLog');
let currentMode = 'hybrid';

// Tab Logic
function switchTab(tab) {
    document.querySelectorAll('[id^="panel-"]').forEach(el => el.classList.add('hidden'));
    document.getElementById('panel-' + tab).classList.remove('hidden');
    
    document.querySelectorAll('[id^="tab-"]').forEach(el => {
        el.className = "flex-1 py-3 text-sm font-medium border-b-2 border-transparent text-muted-foreground hover:text-foreground transition-colors";
    });
    const btn = document.getElementById('tab-' + tab);
    btn.className = "flex-1 py-3 text-sm font-medium border-b-2 border-teal-500 text-teal-500 transition-colors";
    
    // Load GitHub repos when tab is selected
    if (tab === 'github') {
        loadGitHubRepos();
    }
}

// GitHub Repos Loading
async function loadGitHubRepos() {
    const loading = document.getElementById('github-loading');
    const notConnected = document.getElementById('github-not-connected');
    const connected = document.getElementById('github-connected');
    const reposList = document.getElementById('github-repos-list');
    
    loading.classList.remove('hidden');
    notConnected.classList.add('hidden');
    connected.classList.add('hidden');
    
    try {
        const response = await fetch('/github/api/repos/');
        const data = await response.json();
        
        loading.classList.add('hidden');
        
        if (!data.connected || data.repos.length === 0) {
            notConnected.classList.remove('hidden');
            return;
        }
        
        connected.classList.remove('hidden');
        reposList.innerHTML = data.repos.map(repo => `
            <div class="flex items-center justify-between p-3 bg-zinc-900 rounded-lg border border-zinc-800 hover:border-zinc-700 transition-colors">
                <div class="flex items-center gap-3">
                    <i class="fab fa-github text-lg text-zinc-400"></i>
                    <div>
                        <div class="font-medium text-sm">${repo.full_name}</div>
                        <div class="text-xs text-muted">${repo.private ? 'üîí Private' : 'üåê Public'}</div>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="scanGitHubRepo('${repo.full_name}', ${repo.installation_id})" 
                            class="text-xs bg-teal-600 hover:bg-teal-700 px-3 py-1.5 rounded transition-colors">
                        <i class="fas fa-search mr-1"></i> Scan
                    </button>
                    <button onclick="autoFixRepo('${repo.full_name}', ${repo.installation_id})" 
                            class="text-xs bg-zinc-700 hover:bg-zinc-600 px-3 py-1.5 rounded transition-colors">
                        <i class="fas fa-wrench mr-1"></i> Auto-Fix
                    </button>
                </div>
            </div>
        `).join('');
        
    } catch (error) {
        loading.classList.add('hidden');
        notConnected.classList.remove('hidden');
        console.error('Failed to load repos:', error);
    }
}

// Scan GitHub Repo (via installed app)
async function scanGitHubRepo(repoFullName, installationId) {
    log(`Starting scan for ${repoFullName}...`, 'info');
    switchTab('file'); // Switch to terminal view
    
    try {
        const response = await fetch('/github/api/scan/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                repo_full_name: repoFullName,
                installation_id: installationId
            })
        });
        
        const data = await response.json();
        log(data.message || 'Scan initiated', data.error ? 'error' : 'success');
    } catch (error) {
        log(`Error: ${error.message}`, 'error');
    }
}

// Auto-Fix Repo Dependencies
async function autoFixRepo(repoFullName, installationId) {
    log(`Creating fix PR for ${repoFullName}...`, 'info');
    
    try {
        const response = await fetch('/github/api/auto-fix/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                repo_full_name: repoFullName,
                installation_id: installationId,
                findings: []  // Would pass SCA findings here
            })
        });
        
        const data = await response.json();
        if (data.pr_url) {
            log(`‚úÖ Fix PR created: ${data.pr_url}`, 'success');
            window.open(data.pr_url, '_blank');
        } else {
            log(data.message || 'Auto-fix completed', data.error ? 'error' : 'info');
        }
    } catch (error) {
        log(`Error: ${error.message}`, 'error');
    }
}

// Mode Logic
window.setMode = (mode) => {
    currentMode = mode;
    document.querySelectorAll('[role="group"] button').forEach(btn => {
        btn.classList.remove('bg-teal-600', 'text-white', 'shadow-sm');
        btn.classList.add('hover:text-white', 'text-muted-foreground');
    });
    const btn = document.getElementById('btn-' + mode);
    btn.classList.remove('hover:text-white', 'text-muted-foreground');
    btn.classList.add('bg-teal-600', 'text-white', 'shadow-sm');
    log(`Switched to ${mode.toUpperCase()} mode.`);
};

// Logging
const log = (msg, type='info') => {
    const el = document.createElement('div');
    el.className = `log-line log-${type}`;
    const time = new Date().toLocaleTimeString('en-US', {hour12: false});
    el.innerHTML = `<span class="log-time">[${time}]</span> ${msg}`;
    term.appendChild(el);
    term.scrollTop = term.scrollHeight;
};

// --- FILE SCAN ---
const fileInput = document.getElementById('fileInput');
document.getElementById('dropZone').onclick = () => fileInput.click();
fileInput.onchange = (e) => { if(e.target.files.length) startFileScan(e.target.files[0]); };
document.body.ondragover = e => e.preventDefault();
document.body.ondrop = e => {
    e.preventDefault();
    if (e.dataTransfer.files.length) startFileScan(e.dataTransfer.files[0]);
};

async function startFileScan(file) {
    term.innerHTML = '';
    document.getElementById('scanStatus').innerText = "SCANNING...";
    document.getElementById('scanStatus').className = "text-teal-500 animate-pulse uppercase tracking-wider";
    
    // Reset Stats
    document.getElementById('statGrade').innerText = "-";
    document.getElementById('statScore').innerText = "0%";
    document.getElementById('statGrade').className = "text-2xl font-bold";
    document.getElementById('statIssues').innerText = "0";

    log(`Initializing File Scan...`, 'info');
    log(`Target: ${file.name} (${(file.size/1024).toFixed(1)} KB)`, 'info');
    log(`Mode: ${currentMode.toUpperCase()}`, 'info');

    const formData = new FormData();
    formData.append('file', file);
    formData.append('mode', currentMode);

    try {
        const res = await fetch('', { // POST to current URL
            method: 'POST',
            body: formData,
            headers: { 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value }
        });

        if (!res.ok) throw new Error("Server returned " + res.status);
        
        const data = await res.json();
        if(data.error) throw new Error(data.error);

        renderResults(data);

    } catch (e) {
        // Daily Limit Check
        if (e.message && e.message.includes('Daily limit')) {
            log(`‚ö†Ô∏è DAILY LIMIT REACHED (30 scans/day). Please try again tomorrow.`, 'error');
            document.getElementById('scanStatus').innerText = "LIMIT REACHED";
            document.getElementById('scanStatus').className = "text-orange-500 uppercase tracking-wider";
            return;
        }
        log(`CRITICAL ERROR: ${e.message}`, 'error');
        document.getElementById('scanStatus').innerText = "ERROR";
        document.getElementById('scanStatus').className = "text-rose-500 uppercase tracking-wider";
    }
}

// --- REPO SCAN LOGIC (LIVE TERMINAL) ---
async function startRepoScan() {
    const url = document.getElementById('repoUrl').value;
    let speedWarned = false; // Fix: Declare variable in scope
    
    if(!url) {
        log("Error: Please enter a valid Git URL", 'error');
        return;
    }

    term.innerHTML = ''; // Clear terminal
    document.getElementById('findingsTableBody').innerHTML = ''; // Clear table
    document.getElementById('detailReport').classList.add('hidden');
    
    document.getElementById('scanStatus').innerText = "INITIALIZING...";
    document.getElementById('scanStatus').className = "text-teal-500 animate-pulse uppercase tracking-wider";
    
    // Reset Stats
    document.getElementById('statGrade').innerText = "-";
    document.getElementById('statScore').innerText = "0%";
    document.getElementById('statGrade').className = "text-2xl font-bold";
    document.getElementById('statIssues').innerText = "0";
    
    // Phase 1: Clone & Index
    log(`Initializing Repo Scan...`, 'info');
    log(`Target: ${url}`, 'info');
    log(`fetching repository....`, 'warn');
    
    try {
        // 1. Create Project & Index Files
        const initRes = await fetch('{% url "vuln_scan:start_repo_scan" %}', {
            method: 'POST',
            body: new URLSearchParams({ 'repo_url': url, 'mode': currentMode }),
            headers: { 
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value 
            }
        });

        if (!initRes.ok) throw new Error("Server returned " + initRes.status);
        const initData = await initRes.json();
        
        if(initData.error) throw new Error(initData.error);
        
        // Check for Large Repo Warning (Snyk Fallback)
        if(initData.warning) {
             // alert(initData.warning); // Removed blocking alert
             log(`NOTICE: ${initData.warning}`, 'snyk');
        }

        const projectId = initData.project_id;
        const totalFiles = initData.total_files || 0;
        
        log(`Clone Complete. Project ID: ${projectId}`, 'success');
        log(`Found ${totalFiles} source files to analyze.`, 'info');
        log(`Starting sequential analysis pipeline...`, 'warn');
        log('----------------------------------------', 'info');

        // Phase 2: Sequential Scan (The "Matrix" Effect)
        let issuesCount = 0;
        let processed = 0;
        let isComplete = false;
        
        // Initialize UI
        const scanProgressContainer = document.getElementById('scanProgressContainer');
        const scanProgressBar = document.getElementById('scanProgressBar');
        const scanProgressPercent = document.getElementById('scanProgressPercent');
        const scanProgressText = document.getElementById('scanProgressText');
        
        scanProgressContainer.classList.remove('hidden');
        document.getElementById('scanStatus').innerText = "SCANNING...";
        
        while(!isComplete && processed < totalFiles) {
            // Update Progress
            const percentage = Math.round((processed / totalFiles) * 100);
            scanProgressBar.style.width = `${percentage}%`;
            scanProgressPercent.innerText = `${percentage}%`;
            scanProgressText.innerText = `ANALYZING FILE ${processed + 1} / ${totalFiles}`;

            // Request next file scan
            // FIX: Use correct URL prefix 'dashboard' instead of 'vuln'
            // FIX: Pass currentMode to enable AI scanning
            const scanRes = await fetch(`/dashboard/project/${projectId}/scan-file/`, {
                method: 'POST',
                body: new URLSearchParams({ 'mode': currentMode }), // Pass mode here
                headers: { 
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value 
                }
            });
            
            if(!scanRes.ok) {
                log(`[DEBUG] API Error: ${scanRes.status} ${scanRes.statusText}`, 'error');
                break;
            }
            const scanData = await scanRes.json();
            
            // DEBUG: See why it's completing early
            if(scanData.status === 'COMPLETED' || scanData.status === 'COMPLETE') {
                log(`[DEBUG] Received COMPLETE signal. Pending: ${scanData.pending_count || '?'}`, 'warn');
                scanProgressBar.style.width = `100%`;
                scanProgressPercent.innerText = `100%`;
                isComplete = true;
                break;
            }
            
            if(scanData.filename) {
                processed++;
                const fname = scanData.filename;
                const findings = scanData.findings || [];
                issuesCount += findings.length;
                
                // Warn about speed for AI modes (ONCE)
                if (!speedWarned && (currentMode === 'hybrid' || currentMode === 'deep')) {
                    log(`NOTE: ${currentMode.toUpperCase()} Mode enabled. Analysis may be slower due to AI API latency & rate-limiting.`, 'warning');
                    speedWarned = true; // Prevent spam
                }
                
                // Log the file action
                log(`[${processed}/${totalFiles}] Analyzing ${fname}...`, 'info');
                
                // Log specific findings if any
                if(findings.length > 0) {
                     findings.forEach(issue => {
                         const color = issue.severity === 'high' ? 'error' : (issue.severity === 'medium' ? 'warn' : 'info');
                         log(`  > [${issue.type}] ${issue.description || 'Issue detected'}`, color);
                         addFindingRow(issue, fname);
                     });
                     document.getElementById('detailReport').classList.remove('hidden');
                }
                
                // Slight delay for visual effect if it's too fast
                // await new Promise(r => setTimeout(r, 100));
            }
        }
        
        // Phase 3: Completion
        log('----------------------------------------', 'info');
        log(`Repository Analysis Complete.`, 'success');
        log(`Total Files Scanned: ${processed}`, 'info');
        log(`Total Issues Found: ${issuesCount}`, issuesCount > 0 ? 'warn' : 'success');
        
        document.getElementById('scanStatus').innerText = "DONE";
        document.getElementById('scanStatus').className = "text-teal-500 uppercase tracking-wider";
        
        // Update Stats UI
        document.getElementById('statIssues').innerText = issuesCount;
        
    } catch (e) {
        // Daily Limit Check
        if (e.message && e.message.includes('Daily limit')) {
            log(`‚ö†Ô∏è DAILY LIMIT REACHED (30 scans/day). Please try again tomorrow.`, 'error');
            document.getElementById('scanStatus').innerText = "LIMIT REACHED";
            document.getElementById('scanStatus').className = "text-orange-500 uppercase tracking-wider";
            return;
        }
        log(`CRITICAL ERROR: ${e.message}`, 'error');
         document.getElementById('scanStatus').innerText = "ERROR";
        document.getElementById('scanStatus').className = "text-rose-500 uppercase tracking-wider";
    }
}

// --- TABLE HELPER ---
function addFindingRow(issue, filename) {
    const tbody = document.getElementById('findingsTableBody');
    const tr = document.createElement('tr');
    tr.className = "border-b border-[#333] hover:bg-[#2a2a2a] transition-colors";
    
    // Severity Color
    let sevColor = "text-blue-400";
    if(issue.severity === 'high' || issue.severity === 'critical') sevColor = "text-red-500";
    if(issue.severity === 'medium') sevColor = "text-orange-400";
    
    // Line Number
    let lineNum = '-';
    if (issue.location && issue.location.line) lineNum = issue.location.line;
    if (issue.line && issue.line !== '-') lineNum = issue.line; // Fallback only if valid
    
    // Remediation / Fix
    let fixHtml = '';
    if (issue.recommendation) {
        fixHtml = `<div class="mt-2 pt-2 border-t border-zinc-700">
            <span class="text-teal-500 font-bold text-xs uppercase">Recommendation:</span>
            <div class="text-zinc-400 text-xs mt-1 darkable-code">${issue.recommendation}</div>
        </div>`;
    }

    tr.innerHTML = `
        <td class="p-3 ${sevColor} font-bold align-top whitespace-nowrap">${issue.severity.toUpperCase()}</td>
        <td class="p-3 text-gray-300 align-top whitespace-nowrap">${issue.type}</td>
        <td class="p-3 text-gray-400 text-xs font-mono align-top whitespace-nowrap" title="${filename}">${filename ? (filename.length > 20 ? filename.substr(0,17)+'...' : filename) : '-'}</td>
        <td class="p-3 text-teal-500 font-mono text-xs align-top">${lineNum}</td>
        <td class="p-3 text-gray-300 align-top">
            <div class="mb-2">${issue.description || issue.type || 'Potential vulnerability detected'}</div>
            ${fixHtml}
        </td>
    `;
    tbody.appendChild(tr);
}

// --- RENDER LOGIC ---
function renderResults(data) {
    log('Analysis Phase Complete.', 'success');
    document.getElementById('scanStatus').innerText = data.status || "COMPLETE";
    document.getElementById('scanStatus').className = data.status === 'SAFE' ? "text-teal-500 uppercase tracking-wider" : "text-rose-500 uppercase tracking-wider";
    
    // Stats Update
    document.getElementById('statIssues').innerText = data.findings ? data.findings.length : 0;
    
    // Grade Update
    if (data.security_grade) {
        const gradeEl = document.getElementById('statGrade');
        const scoreEl = document.getElementById('statScore');
        gradeEl.innerText = data.security_grade;
        scoreEl.innerText = (data.security_score || 0) + '%';
        
        // Color
        gradeEl.className = "text-2xl font-bold";
        if(data.security_grade === 'A') gradeEl.classList.add('text-green-500');
        else if(data.security_grade === 'B') gradeEl.classList.add('text-teal-500');
        else if(data.security_grade === 'C') gradeEl.classList.add('text-yellow-500');
        else if(data.security_grade === 'D') gradeEl.classList.add('text-orange-500');
        else gradeEl.classList.add('text-red-500');
    }
    
    document.getElementById('findingsTableBody').innerHTML = '';
    document.getElementById('detailReport').classList.add('hidden');
    
    // Print Findings
    log('----------------------------------------', 'info');
    if (data.findings && data.findings.length > 0) {
        document.getElementById('detailReport').classList.remove('hidden');
        
        data.findings.forEach(f => {
            const isSnyk = f.source === 'snyk';
            const prefix = isSnyk ? '[SNYK]' : '';
            const type = isSnyk ? 'snyk' : (f.severity === 'high' ? 'error' : 'warn');
            
            log(`${prefix} [${f.severity.toUpperCase()}] ${f.type}: ${f.description || f.reason}`, type);
            // Use finding-specific filename (f.filename) if available, otherwise fallback to project/file name (data.filename)
            addFindingRow(f, f.filename || data.filename);
            
            if(f.location) {
                log(`   @ ${f.location.file || 'line'}:${f.location.line}`, 'info');
            }
        });
    } else {
        log('No vulnerabilities detected. Clean execution.', 'success');
    }
    
    // VirusTotal
    if(data.virustotal) {
        log(`VirusTotal: ${data.virustotal.malicious} malicious flags`, data.virustotal.malicious > 0 ? 'error' : 'success');
    }
}

async function loadHistoryItem(id, type) {
    // Clear State
    term.innerHTML = '';
    document.getElementById('findingsTableBody').innerHTML = '';
    document.getElementById('detailReport').classList.add('hidden');
    document.getElementById('scanStatus').innerText = "LOADING HISTORY...";
    document.getElementById('scanStatus').className = "text-yellow-500 animate-pulse uppercase tracking-wider";
    
    log(`Fetching history for ${type} #${id}...`, 'info');
    
    try {
        let url = '';
        if (type === 'file') {
            url = `/dashboard/get_result/${id}/`;
        } else {
             // Project status endpoint
            url = `/dashboard/project/${id}/status/`;
        }
        
        const res = await fetch(url);
        if(!res.ok) throw new Error(`Fetch failed: ${res.status}`);
        
        const data = await res.json();
        
        // Check if data is valid
        if (!data || data.error) {
            throw new Error(data.error || 'Invalid response');
        }
        
        // Normalize Data for Render
        if(type === 'project') {
             data.filename = data.project_name || `Project #${id}`;
             data.status = data.status || 'UNKNOWN';
             
             // Findings are now already detailed from the backend (views.py)
             // No manual conversion needed.
        } else {
            // File data usually nested in 'result' key
            if (data.result) {
                Object.assign(data, data.result);
            }
            data.filename = data.filename || `File #${id}`;
        }
        
        // Final validation - check if we have valid findings or at least a status
        if (!data.status && (!data.findings || data.findings.length === 0)) {
            log(`Session data expired or empty. Start a new scan to see detailed results.`, 'warn');
            document.getElementById('scanStatus').innerText = "NO DATA";
            document.getElementById('scanStatus').className = "text-yellow-500 uppercase tracking-wider";
            return;
        }
        
        renderResults(data);
        log(`History loaded successfully.`, 'success');
        
    } catch (e) {
        log(`Session expired or unavailable. Try a new scan.`, 'warn');
        log(`(Technical: ${e.message})`, 'info');
        document.getElementById('scanStatus').innerText = "EXPIRED";
        document.getElementById('scanStatus').className = "text-yellow-500 uppercase tracking-wider";
    }
}
</script>
{% endblock %}
